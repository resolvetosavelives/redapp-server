<% csv = CSV.generate(headers: true) do |csv| %>
<% csv << ["Report generated at:", Time.current] %>
<% period = @period == :quarter ? 'Quarterly' : 'Monthly' %>
<% csv << ["#{@facility.name} #{period} Cohort Report"] %>
<% csv << [
  'Cohort period',
  'Follow up period',
  'Patients in cohort',
  'Patients followed up',
  'Patients controlled',
  'Patients uncontrolled',
  "Patients didn't attend",
  'Control rate',
  'Uncontrolled rate',
  'Default rate'
] %>
<% @cohort_analytics.each_with_index do |(report_dates, analytics), _| %>
  <%
    cohort_start, report_start = report_dates
    registered = analytics.dig(:cohort_patients, :total) || 0
    followed_up = analytics.dig(:followed_up, :total) || 0
    defaulted = analytics.dig(:defaulted, :total) || 0
    controlled = analytics.dig(:controlled, :total) || 0
    uncontrolled = analytics.dig(:uncontrolled, :total) || 0

    if @period == :quarter
      report_period = quarter_string(report_start)
      cohort_period = quarter_string(cohort_start)
    else
      report_end = (report_start + 1.month).end_of_month

      formatted_report_start_date = report_start.strftime("%B #{report_start.day.ordinalize}")
      formatted_report_end_date = report_end.strftime("%B #{report_end.day.ordinalize}")

      report_period = [formatted_report_start_date, formatted_report_end_date].join(" â€“ ")
      cohort_period = cohort_start.strftime("%b %Y")
    end

    if registered > 0
      controlled_percent = (controlled.to_f / registered * 100).round
      uncontrolled_percent = (uncontrolled.to_f / registered * 100).round
      default_percent = (defaulted.to_f / registered * 100).round
    else
      controlled_percent = 0
      uncontrolled_percent = 0
      default_percent = 0
    end
  %>
<% csv << [
  cohort_period,
  report_period,
  registered,
  followed_up,
  controlled,
  uncontrolled,
  defaulted,
  "#{controlled_percent}%",
  "#{uncontrolled_percent}%",
  "#{default_percent}%"
] %>
<% end %>
<% end.html_safe %>
<%= csv %>

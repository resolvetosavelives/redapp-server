<%= [
  "Report generated at:",
  Time.current
].to_csv -%>
<%= ["#{@facility.name} Cohort Report"].to_csv -%>
<%= [
  "Cohort period",
  "Follow up period",
  "Patients registered",
  "Patients followed up",
  "Patients controlled",
  "Patients uncontrolled",
  "Patients defaulted",
  "Control rate",
  "Uncontrolled rate",
  "Default rate"
].to_csv -%>
<% @cohort_analytics.each_with_index do |(report_dates, analytics), index| %>
  <%
    cohort_start, report_start = report_dates
    registered = analytics.dig(:registered, :total) || analytics[:registered]
    followed_up = analytics.dig(:followed_up, :total) || analytics[:followed_up]
    defaulted = analytics.dig(:defaulted, :total) || analytics[:defaulted]
    controlled = analytics.dig(:controlled, :total) || analytics[:controlled]
    uncontrolled = analytics.dig(:uncontrolled, :total) || analytics[:uncontrolled]
    if @period == :quarter
      report_period = quarter_string(report_start)
      cohort_period = quarter_string(cohort_start)
    else
      report_period = [report_start.strftime("%b %-d"), (report_start + 1.month).end_of_month.strftime("%b %-d")].join("-")
      cohort_period = cohort_start.strftime("%b %Y")
    end
    if registered > 0
      controlled_percent = (controlled.to_f / registered * 100).round
      uncontrolled_percent = (uncontrolled.to_f / registered * 100).round
      default_percent = (defaulted.to_f / registered * 100).round
    else
      controlled_percent = 0
      uncontrolled_percent = 0
      default_percent = 0
    end
  %>
<%= [
  cohort_period,
  report_period,
  registered,
  followed_up,
  controlled,
  uncontrolled,
  defaulted,
  "#{controlled_percent}%",
  "#{uncontrolled_percent}%",
  "#{default_percent}%"
].to_csv -%>
<% end %>

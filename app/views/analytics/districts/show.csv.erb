<%= [
  "Report generated at:",
  Time.current
].to_csv -%>
<%= ["#{@organization_district.district_name} Cohort Report"].to_csv -%>
<%= [
  "Cohort period",
  "Follow up period",
  "Patients registered",
  "Patients followed up",
  "Patients controlled",
  "Patients uncontrolled",
  "Patients defaulted",
  "Control rate",
  "Uncontrolled rate",
  "Default rate"
].to_csv -%>
<% @cohort_analytics.each_with_index do |(report_dates, analytics), index| %>
  <%
    cohort_start, report_start = report_dates
    registered = analytics[:registered]
    followed_up = analytics[:followed_up]
    defaulted = analytics[:defaulted]
    controlled = analytics[:controlled]
    uncontrolled = analytics[:uncontrolled]
    if @period == :quarter
      report_period = quarter_string(report_start)
      cohort_period = quarter_string(cohort_start)
    else
      report_period = [report_start.strftime("%b %-d"), (report_start + 1.month).end_of_month.strftime("%b %-d")].join("-")
      cohort_period = cohort_start.strftime("%b %Y")
    end
    if registered > 0
      controlled_percent = (controlled.to_f / registered * 100).round
      uncontrolled_percent = (uncontrolled.to_f / registered * 100).round
      default_percent = (defaulted.to_f / registered * 100).round
    else
      controlled_percent = 0
      uncontrolled_percent = 0
      default_percent = 0
    end
  %>
<%= [
  cohort_period,
  report_period,
  registered,
  followed_up,
  controlled,
  uncontrolled,
  defaulted,
  "#{controlled_percent}%",
  "#{uncontrolled_percent}%",
  "#{default_percent}%"
].to_csv -%>
<% end %>

<%= ["#{@organization_district.district_name} Facilites Report"].to_csv -%>
<%
  headers = [
    "Facility name",
    "Total registered patients"
  ]
  dates = dates_for_periods(@period, 3, include_current_period: @show_current_period)
  ["Follow up patients", "Registered patients"].each do |metric|
    dates.each do |date|
      headers << "#{metric} #{date}"
    end
  end
%>
<%= headers.to_csv -%>
<%=
  [
    "All",
    @dashboard_analytics.sum { |_, row| row[:total_registered_patients] || 0 },
    *dates.map { |period| analytics_totals(@dashboard_analytics, :follow_up_patients_by_period, period) },
    *dates.map { |period| analytics_totals(@dashboard_analytics, :registered_patients_by_period, period) }
  ].to_csv
-%>
<%
  line = nil
  row_resource = Facility.order(:name)
  row_resource_description = "Facilities"
  row_resource_display_field = :name
%>
<% policy_scope([:cohort_report, row_resource]).each do |resource| %>
  <% if @dashboard_analytics[resource.id].present? %>
    <%=
      [
        resource.send(row_resource_display_field),
        @dashboard_analytics.dig(resource.id, :total_registered_patients) || 0,
        *dates.map { |period| @dashboard_analytics.dig(resource.id, :follow_up_patients_by_period, period) || 0 },
        *dates.map { |period| @dashboard_analytics.dig(resource.id, :registered_patients_by_period, period) || 0 }
      ].to_csv
    -%>
  <% end %>
<% end %>

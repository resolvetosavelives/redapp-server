<% headers = [
  "Patient name",
  "Gender",
  "Age",
  "Registration date",
  "Last BP",
  "Last BP taken at",
  "Last BP date",
  "Risk level",
  "Patient address",
  "Patient village or colony",
  "Patient phone"
] %>
<% export = CSV.generate("", headers: headers, write_headers: true) do |csv| %>
  <% @patients.each do |patient| %>
    <% row = [
         patient.full_name,
         patient.gender.capitalize,
         patient.current_age,
         patient.registration_date,
         patient.latest_blood_pressure.to_s,
         patient.latest_blood_pressure.facility.name,
         display_date(patient.latest_blood_pressure.recorded_at),
         ('High' if patient.high_risk?),
         patient.address.street_address,
         patient.address.village_or_colony,
         patient.phone_numbers.first&.number
       ]
       csv.add_row row %>
  <% end %>
<% end %>

<%= export.lstrip.html_safe %>

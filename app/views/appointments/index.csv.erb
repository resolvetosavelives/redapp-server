<%= [
  "Patient name",
  "Gender",
  "Age",
  "Days overdue",
  "Last BP",
  "Last BP taken at",
  "Last BP date",
  "Risk level",
  "Patient address",
  "Patient village or colony",
  "Patient phone"
].to_csv -%>
<%- @appointments.group_by { |a| a.patient.latest_blood_pressure.facility }.each do |facility, facility_appointments| %>
<%- facility_appointments.sort_by { |a| a.patient.risk_priority }.each do |appointment| %>
<%= [
  appointment.patient.full_name,
  appointment.patient.gender.capitalize,
  appointment.patient.current_age,
  appointment.days_overdue,
  appointment.patient.latest_blood_pressure.to_s,
  appointment.patient.latest_blood_pressure.facility.name,
  appointment.patient.latest_blood_pressure.device_created_at.to_date,
  appointment.patient.risk_priority_label,
  appointment.patient.address.street_address,
  appointment.patient.address.village_or_colony,
  appointment.patient.phone_numbers.first&.number
].to_csv -%>
<%- end %>
<%- end %>

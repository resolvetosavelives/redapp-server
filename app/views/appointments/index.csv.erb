<% headers = [
  "Patient name",
  "Gender",
  "Age",
  "Days overdue",
  "Registration date",
  "Last BP",
  "Last BP taken at",
  "Last BP date",
  "Risk level",
  "Patient address",
  "Patient village or colony",
  "Patient phone"
] %>
<% export = CSV.generate("", headers: headers, write_headers: true) do |csv| %>
  <% @appointments.each do |appointment| %>
    <% row = [
         "Did this, did this work?",
         appointment.patient.gender.capitalize,
         appointment.patient.current_age,
         appointment.days_overdue,
         appointment.patient.registration_date,
         appointment.patient.latest_blood_pressure.to_s,
         appointment.patient.latest_blood_pressure.facility.name,
         display_date(appointment.patient.latest_blood_pressure.recorded_at),
         ('High' if appointment.patient.high_risk?),
         appointment.patient.address.street_address,
         appointment.patient.address.village_or_colony,
         appointment.patient.phone_numbers.first&.number
       ]
       csv.add_row row %>
  <% end %>
<% end %>

<%= export.lstrip.html_safe %>

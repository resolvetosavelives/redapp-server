<!DOCTYPE html>
<html lang="en" style="scroll-behavior: auto;">
<head>
  <meta charset="utf-8">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,shrink-to-fit=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <title><%= raw t("analytics.page_title") %></title>

  <%= inline_stylesheet("user_analytics.css") %>
</head>

<body id="progress">
  <div id="progress-start" class="progress-body">
    <div class="progress-contents">

      <div id="drug-stock-form" class="progress-body">
        <div class="progress-contents">
          <a href="#" onclick="closeWindow('drug-stock-form', 'progress-start'); return false" class="help-back">
            <%= inline_svg('icon_back.svg') %>
          </a>
          <h2 style="padding-top: 80px; padding-left: 8px;">Number of tablets</h2>
          <p style="text-align: left; padding: 0 8px 1em 8px;">Leave blank if unknown. Enter "0" if stock is empty.</p>

          <%= bootstrap_form_with(url: webview_drug_stocks_url(format: :json),
            method: :post,
            autocomplete: "off",
            label_errors: true) do |form| %>
            <%= form.hidden_field :facility_id, value: current_facility.id %>
            <%= form.hidden_field :user_id, value: current_user.id %>
            <%= form.hidden_field :access_token, value: current_user.access_token %>

          <div class="form-group mt-4">
            <label for="drug-stock-date">Drug stock report for:</label>
            <div class="form-row">
              <% options = last_n_months(n: 6, inclusive: true).map { |d| [d.strftime("%b-%Y"), d.strftime("%b-%Y")] } %>
              <%= form.select :for_end_of_month, options, class: "form-control" %>
            </div>
          </div>

          <% @protocol_drugs.each do |protocol_drug| %>
            <%= form.fields_for "drug_stocks[]", DrugStock.new do |drug_stock_form| %>
              <%= drug_stock_form.hidden_field :protocol_drug_id, value: protocol_drug.id %>

              <div class="form-group mt-4">
                  <label for=""><%= "#{protocol_drug.name} #{protocol_drug.dosage}"%></label>
                  <div class="form-row">
                    <div class="col">
                      <%= drug_stock_form.number_field :received, class: :received, value: @drug_stocks[protocol_drug.id].try(&:received), hide_label: true, help: "Received during the month" %>
                    </div>
                    <div class="col">
                      <%= drug_stock_form.number_field :in_stock, class: :in_stock, value: @drug_stocks[protocol_drug.id].try(&:in_stock), hide_label: true, help: "Stock at end of the month" %>
                    </div>
                  </div>
              </div>
            <% end %>
          <% end %>

          <div class="button-fixed-bottom">
            <%= form.button "SAVE", class: "button" %>
            <%# <button onclick="openWindow('drug-stock-submitted', 'drug-stock-form'); return false" class="button">SAVE</button> %>
          </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  </body>
</html>
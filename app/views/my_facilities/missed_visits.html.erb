<% if current_admin.feature_enabled?(:my_facilities_improvements) %>
  <div class="row">
    <div class="col-lg-12">
      <div class="card card-responsive">
        <div class="d-flex align-baseline jc-between">
          <h3>
            Missed visits
          </h3>
          <p class="c-grey-dark">
            Last updated: <%= @last_updated_at %>
          </p>
        </div>
        <p class="c-grey-dark">
          <strong>What to look for:</strong> Low percentages are good, and 20% or lower is ideal 
        </p>
        <div class="d-flex fw-wrap mb-16px">
          <%= render "shared/size_and_zone_filters" %>
        </div>
        <% %w(large medium small community).each do |size| %>
          <% next if @facilities_by_size[size].blank? %>
          <p class="mt-20px mb-0px fw-bold">
            <%= size.capitalize %> facilities
          </p>
          <table class="mt-3 mt-lg-4 table table-compact table-responsive-md table-hover analytics-table">
            <colgroup>
              <col>
              <col>
              <col>
              <col class="table-divider">
              <col>
              <col class="table-divider">
              <col>
              <col class="table-divider">
              <col>
              <col class="table-divider">
              <col>
              <col class="table-divider">
              <col>
              <col class="table-divider">
              <col>
              <col class="table-divider">
              <col>
            </colgroup>
            <thead>
              <tr data-sort-method="thead" class="sorts">
                <th class="row-label sort-label sort-label-small" style="width: 160px;">
                  Facilities
                </th>
                <th class="row-label sort-label sort-label-small" data-sort-method="number" style="width: 120px;">
                  Total assigned<br>patients
                </th>
                <th class="row-label sort-label sort-label-small" data-sort-method="number" style="width: 120px;">
                  Total registered<br>patients
                </th>
                <th class="row-label sort-label sort-label-small" colspan="2" style="width: 80px;">
                  6-month change
                </th>
                <% (@start_period..@period).each do |period| %>
                  <th class="row-label sort-label sort-label-small" data-sort-method="number" colspan="2">
                    <%= period %>
                  </th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% @facilities_by_size[size].each do |facility| %>
                <% six_month_rate_change = @data_for_facility[facility.name]["missed_visits_rate"][@period] - @data_for_facility[facility.name]["missed_visits_rate"][@start_period] || 0 %>
                <tr data-row="<%= facility.slug %>" data-trend-color="<%= six_month_rate_change >= 0 ? "red" : "green" %>">
                  <td class="type-title">
                    <%= link_to(reports_region_path(facility, report_scope: "facility")) do %>
                      <%= facility.name %>
                    <% end %>
                  </td>
                  <td>
                    <%= number_with_delimiter(@data_for_facility[facility.name]["adjusted_registrations"].values.last || 0) %>
                  </td>
                  <td>
                    <%= number_with_delimiter(@data_for_facility[facility.name]["cumulative_registrations"].values.last || 0) %>
                  </td>
                  <td>
                    <div class="w-80px h-20px">
                      <canvas id=<%= facility.slug %>></canvas>
                    </div>
                  </td>
                  <td class="fw-bold ta-center <%= six_month_rate_change >= 0 ? "c-red-dark" : "c-green-dark" %>">
                    <%= six_month_rate_change >= 0 ? "+" : "" %><%= number_to_percentage(six_month_rate_change, precision: 0) %>
                  </td>
                  <% (@start_period..@period).each do |period| %>
                    <td>
                      <%= @data_for_facility[facility.name]["missed_visits"][period] %>
                    </td>
                    <td class="type-percent">
                      <% missed_visits_rate = @data_for_facility[facility.name]["missed_visits_rate"][period] %>
                      <em data-rate="<%= missed_visits_rate %>">
                        <%= number_to_percentage(missed_visits_rate || 0, precision: 0) %>
                      </em>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<% else %>
  <div class="row">
    <div class="col-lg-12">
      <div class="card card-responsive">
        <header>
          <div class="d-flex align-baseline jc-between">
            <h3>
              Missed visits
            </h3>
            <p class="c-grey-dark">
              Last updated: <%= @last_updated_at %>
            </p>
          </div>
          <% case @selected_period %>
            <% when :quarter %>
              <% example_quarter = @display_periods.first %>
              <% following_quarter = next_year_and_quarter(*example_quarter) %>
              <p>
                Patients who were registered during a quarter <%= "(eg: Q#{example_quarter.second}-#{example_quarter.first})" %>, and had no BPs recorded in the following quarter <%= "(Q#{following_quarter.second}-#{following_quarter.first})" %>
              </p>
            <% when :month %>
              <% example_month = @display_periods.first %>
              <% following_months = month_short_name_and_year(local_month_start(*example_month) + 1.months) + ', ' + month_short_name_and_year(local_month_start(*example_month) + 2.months) %>
              <p>
                Patients who were registered during a month <%= "(eg: #{month_short_name_and_year(local_month_start(*example_month))})" %>, and had no BPs recorded in the following two months <%= "(#{following_months})" %>
              </p>
          <% end %>
        </header>
        <div class="d-flex fw-wrap">
          <%= render "shared/size_and_zone_filters" %>
          <div class="dropdown show">
            <a
              id="dropdownMenuLink"
              class="btn btn-sm btn-outline btn-secondary dropdown-toggle"
              href="#"
              role="button"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              <%= PeriodSelection::PERIODS[:missed_visits][@selected_period] %>
            </a>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
              <% PeriodSelection::PERIODS[:missed_visits].each do |period, period_name| %>
                <button
                  class="dropdown-item filter-by-period <%= "active" if period.to_s == @selected_period.to_s %>"
                  value="<%= period %>"
                  name="period"
                  type="submit"
                  form="query-filters"
                  onclick="$('#selected-period').remove()"
                >
                  <%= period_name %>
                </button>
              <% end %>
            </div>
          </div>
          <input
            id="selected-period"
            name="period"
            value="<%= @selected_period %>"
            form="query-filters"
            hidden
          >
        </div>
        <table class="mt-5 table table-compact table-responsive-md table-hover analytics-table">
          <colgroup>
            <col/>
            <% @display_periods.each do %>
              <col class="table-divider"/>
              <col/>
            <% end %>
            <col class="table-divider"/>
            <col class="table-divider"/>
            <col class="mobile"/>
          </colgroup>
          <thead>
            <tr>
              <th></th>
              <% case @selected_period %>
              <% when :quarter %>
                <% @display_periods.reverse.each do |(year, quarter)| %>
                  <th colspan="2"><%= "Reg in Q#{quarter}-#{year}" %></th>
                <% end %>
              <% when :month %>
                <% @display_periods.reverse.each do |(year, month)| %>
                  <th colspan="2"><%= "Reg in #{month_short_name_and_year(local_month_start(year, month))}" %></th>
                <% end %>
              <% end %>
              <th>Calls&nbsp;made<sup>1</sup></th>
              <th>Total<sup>2</sup></th>
            </tr>
            <tr data-sort-method="thead" class="sorts">
              <th class="row-label sort-label">Facilities</th>
              <% @display_periods.reverse.each do |(year, period)| %>
                <th class="row-label sort-label" data-sort-default>%</th>
                <% case @selected_period %>
                  <% when :quarter %>
                    <% visited_in_year, visited_in_quarter = next_year_and_quarter(year, period) %>
                    <th class="row-label sort-label">No BP taken<br>in <%= "Q#{visited_in_quarter}-#{visited_in_year}" %></th>

                  <% when :month %>
                    <% visited_in_months =
                            month_short_name(month_start(year, period) + 1.months) +
                                '/' +
                                month_short_name(month_start(year, period) + 2.months) %>
                    <th class="row-label sort-label">No BP taken in <%= visited_in_months %></th>
                <% end %>
              <% end %>
              <th class="row-label sort-label">
                <% case @selected_period %>
                <% when :quarter %>
                  <%= "Q#{@display_periods.first.second}-#{@display_periods.first.first}" %>
                <% when :month %>
                  <%= month_short_name_and_year(local_month_start(@display_periods.first.first,
                                                                  @display_periods.first.second)) %>
                <% end %>
              </th>
              <th class="row-label sort-label">Total patients</th>
              <th class="mobile">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
            </tr>
          </thead>
          <tbody>
            <tr class="row-total" data-sort-method="none">
              <td class="type-title">All</td>
              <% @display_periods.reverse.each do |period| %>
                <td class="type-percent" data-sort-column-key="<%= period.join %>">
                  <em><%=
                    percentage(@totals_by_period.dig(period, :missed),
                                @totals_by_period.dig(period, :patients))
                  %></em>
                </td>
                <td class="type-number">
                  <%= number_or_dash_with_delimiter(@totals_by_period.dig(period, :missed).to_i) %>
                </td>
              <% end %>
              <td class="type-number"><%= number_or_dash_with_delimiter(@calls_made.values.sum) %></td>
              <td class="type-number"><%= number_or_dash_with_delimiter(@total_patients_per_facility.values.sum) %></td>
            </tr>
            <% @facilities.each do |facility| %>
              <tr>
                <td class="type-title"><%= link_to facility.name, reports_region_facility_path(facility) %></td>
                <% @display_periods.reverse.each do |period| %>
                  <td class="type-percent" data-sort-column-key="<%= period.join %>">
                    <em><%=
                      percentage(@missed_visits_by_facility.dig([facility.id, *period], :missed),
                                  @missed_visits_by_facility.dig([facility.id, *period], :patients))
                    %></em>
                  </td>
                  <td class="type-number">
                    <%= number_or_dash_with_delimiter(@missed_visits_by_facility.dig([facility.id, *period], :missed).to_i) %>
                  </td>
                <% end %>
                <td class="type-number"><%= number_or_dash_with_delimiter(@calls_made.dig(facility.id) || 0) %></td>
                <td class="type-number"><%= number_or_dash_with_delimiter(@total_patients_per_facility[facility.id].to_i) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
    <section class="footnotes">
      <ol>
        <li><strong>Calls made:</strong> The number of secure calls (only) made through the Simple app that connected to
          the patient. Note that this may significantly undercount calls made, if the user made a normal call using
          their
          personal phone number or used another phone.
        </li>
        <li><strong>Total patients:</strong> Patients with this preferred facility.</li>
      </ol>
    </section>
  </div>
<% end %>
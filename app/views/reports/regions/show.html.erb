<%= render "header" %>
<div class="d-lg-flex flex-lg-wrap mb-48px">
  <div class="d-lg-flex w-lg-50 pr-lg-2">
    <div class="card d-lg-flex fd-lg-column justify-lg-between h-lg-full w-lg-full mt-lg-0">
      <div>
        <div class="mb-2">
          <h3 class="c-black">
            HTN controlled
          </h3>
          <p class="c-grey-dark">
            Registered HTN patients with BP &lt;140/90 at their most recent visit in the last 3 months
          </p>
        </div>
        <div>
          <h3 class="mb-1 fs-xlarge fw-bold <% if @data[:controlled_patients_rate].values.last %>c-green-dark<% else %>c-grey-medium<% end %>">
            <% if @data[:controlled_patients_rate].values.last %>
              <%= number_to_percentage(@data[:controlled_patients_rate].values.last, precision: 0) %>
            <% else %>
              No data
            <% end %>
          </h3>
          <p class="<% if @data[:controlled_patients_rate].values.last %>c-black<% else %>c-grey-medium<% end %>">
            <% if @data[:controlled_patients_rate].values.last %>
              <span class="fw-bold"><%= number_with_delimiter(@data[:controlled_patients].values.last) %></span> of <%= number_with_delimiter(@last_registration_value) %> registered patients
            <% else %>
              No control rate data available
            <% end %>
          </p>
        </div>
      </div>
      <div>
        <div class="p-relative">
          <div class="h-200px">
            <canvas id="controlledPatientsTrend"></canvas>
          </div>
          <div class="p-absolute t-0 l-0 pe-none d-flex align-center jc-center w-100pt h-100pt">
            <% unless @data[:controlled_patients_rate].values.last %>
              <p class="c-grey-medium">
                No data available
              </p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="d-lg-flex w-lg-50 pl-lg-2">
    <div class="card d-lg-flex fd-lg-column justify-lg-between h-lg-full w-lg-full mt-lg-0">
      <div>
        <div class="mb-2">
          <h3 class="c-black">
            No BP measure
          </h3>
          <p class="c-grey-dark">
            Registered HTN patients with no BP measure recorded in the last 3 months
          </p>
          <div>
            <!--
              <div class="d-flex align-baseline mb-8px mb-lg-12px">
                <div class="w-12px h-12px mr-12px br-4px bg-grey-lightest"></div>
                <div class="d-flex flex-1 align-baseline">
                  <p class="w-48px m-0px fw-bold fs-20px lh-1">
                    10%
                  </p>
                  <p class="flex-1 m-0px fs-14px">
                    Lost to follow-up
                  </p>
                </div>
              </div>
              <div class="d-flex align-baseline mb-8px mb-lg-12px">
                <div class="w-12px h-12px mr-12px br-4px bg-grey-light"></div>
                <div class="d-flex flex-1 align-baseline">
                  <p class="w-48px m-0px fw-bold fs-20px lh-1">
                    40%
                  </p>
                  <p class="flex-1 m-0px fs-14px">
                    Missed visit
                  </p>
                </div>
              </div>
              <div class="d-flex align-baseline mb-8px mb-lg-12px">
                <div class="w-12px h-12px mr-12px br-4px bg-grey-medium"></div>
                <div class="d-flex flex-1 align-baseline">
                  <p class="w-48px m-0px fw-bold fs-20px lh-1">
                    4%
                  </p>
                  <p class="flex-1 m-0px fs-14px">
                    Visited in the last 3 months but no BP measure
                  </p>
                </div>
              </div>
            -->
            <h3 class="mb-1 fs-xlarge fw-bold c-grey-medium">
              No data
            </h3>
            <p class="c-grey-medium">
              Data coming soon
            </p>
          </div>
        </div>
      </div>
      <div>
        <!--
          <div class="h-200px">
            <canvas id="noBPMeasureTrend"></canvas>
          </div>
        -->
        <div class="d-flex align-center jc-center h-200px bb-1px bl-1px bb-grey-medium bl-grey-medium">
          <p class="c-grey-medium">
            Graphs coming soon
          </p>
        </div>
      </div>
    </div>
  </div>
  <div class="d-lg-flex w-lg-50 pr-lg-2">
    <div class="card d-lg-flex fd-lg-column justify-lg-between h-lg-full w-lg-full mt-lg-0">
      <div>
        <div class="mb-2">
          <h3 class="c-black">
            HTN not under control
          </h3>
          <p class="c-grey-dark">
            Registered HTN patients with BP &ge;140/90 at their most recent visit in the last 3 months
          </p>
        </div>
        <div>
          <h3 class="mb-1 fs-xlarge fw-bold <% if @data[:controlled_patients_rate].values.last %>c-red<% else %>c-grey-medium<% end %>">
          <%
            current_uncontrolled_rate = @data[:uncontrolled_patients_rate]&.values&.last
           %>
            <% if current_uncontrolled_rate %>
              <%= number_to_percentage(current_uncontrolled_rate, precision: 0) %>
            <% else %>
              No data
            <% end %>
          </h3>
          <p class="<% if current_uncontrolled_rate %>c-black<% else %>c-grey-medium<% end %>">
            <% if current_uncontrolled_rate %>
              <span class="fw-bold">
                <%= number_with_delimiter(@data[:uncontrolled_patients].values.last) %>
                </span> of <%= number_with_delimiter(@last_registration_value) %> registered patients
            <% else %>
              No control rate data available
            <% end %>
          </p>
        </div>
      </div>
      <div>
        <div class="p-relative">
          <div class="h-200px">
            <canvas id="uncontrolledPatientsTrend"></canvas>
          </div>
          <div class="p-absolute t-0 l-0 pe-none d-flex align-center jc-center w-100pt h-100pt">
            <% unless @data[:controlled_patients_rate].values.last %>
              <p class="c-grey-medium">
                No data available
              </p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="d-lg-flex w-lg-50 pl-lg-2">
    <div class="card d-lg-flex justify-lg-between h-lg-full w-lg-full mt-lg-0">
      <div>
        <div class="mb-2">
          <h3 class="c-black">
            Cumulative registrations
          </h3>
          <p class="c-grey-dark">
            Total number of HTN patient registrations in <%= @region.name %>
          </p>
        </div>
        <div>
          <h3 class="mb-1 fs-xlarge fw-bold <% if @last_registration_value.zero? %>c-grey-medium<% else %>c-purple<% end %>">
            <% if @last_registration_value.zero? %>
              No data
            <% else %>
              <%= number_with_delimiter(@last_registration_value) %> patients
            <% end %>
          </h3>
          <p class="<% if @last_registration_value.zero? %>c-grey-medium<% else %>c-black<% end %>">
            <% if @last_registration_value.zero? %>
              No registration data available
            <% else %>
              <span class="fw-bold"><%= @controlled_patients.values.last %> (<%= number_to_percentage(@data[:controlled_patients_rate].values.last, precision: 0) %>)</span> controlled patients
            <% end %>
          </p>
        </div>
      </div>
      <div>
        <%
          max_y_value = if @last_registration_value >= 0
            @last_registration_value.ceil(-1)
          else
            0
          end
        %>
        <div class="p-relative">
          <div class="d-flex h-200px">
            <% @registrations.each_with_index do |registrations, index| %>
              <%
                total_registrations = registrations[1]
                registration_percent = compute_percentage(registrations[1], max_y_value)
              %>
              <div class="d-flex flex-1 fd-column jc-flex-end px-1px">
                <% if total_registrations > 0 %>
                  <table class="split-bars" style="height: <%= registration_percent %>;">
                    <tr style="height: <%= registration_percent %>">
                      <td
                        class="bt-2px bt-purple-dark bg-purple-light"
                        data-toggle="tooltip"
                        data-placement="top"
                        data-trigger="hover focus click"
                        title="<%= number_with_delimiter(registrations[1]) %> patients in <%= registrations[0] %>"
                      >
                      </td>
                    </tr>
                  </table>
                <% else %>
                  <table class="split-bars h-10pt">
                    <tr class="h-100pt">
                      <td
                        class="bt-2px bt-grey-medium bg-grey-light"
                        data-toggle="tooltip"
                        data-placement="top"
                        data-trigger="hover focus click"
                        title="No registration data available"
                      >
                      </td>
                    </tr>
                  </table>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="p-absolute t-0 l-0 pe-none d-flex align-center jc-center w-100pt h-100pt bb-1px bl-1px bb-grey-medium bl-grey-medium">
            <% if @last_registration_value.zero? %>
              <p class="c-grey-medium">
                No data available
              </p>
            <% end %>
          </div>
          <% if @last_registration_value.nonzero? %>
            <div class="p-absolute t-0 l-0 pe-none d-flex fd-column h-100pt">
              <div class="flex-1 ml-8px">
                <p class="c-grey-medium">
                  <%= number_with_delimiter(max_y_value) %>
                </p>
              </div>
              <div class="flex-1 ml-8px">
                <p class="c-grey-medium">
                  <%= number_with_delimiter((max_y_value/2).to_i) %>
                </p>
              </div>
            </div>
          <% end %>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <p class="mb-0px">
            <%= @registrations.keys[0] %>
          </p>
          <p class="mb-0px">
            <% total_controlled_patient_periods = @controlled_patients.length - 1 %>
            <%= @controlled_patients.keys[total_controlled_patient_periods] %>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
<% if @region.is_a?(FacilityGroup) %>
  <h3 class="mb-8px fs-28px c-black">
    Facilities in <%= @region.name %>
  </h3>
  <p class="mb-24px fs-16px c-grey-dark">
    <span class="fw-bold">Total:</span> <%= @region.facilities.length %> facilities
  </p>
  <div class="d-lg-flex flex-lg-wrap">
    <div class="d-lg-flex w-lg-50 pr-lg-2">
      <div class="card d-lg-flex fd-lg-column justify-lg-between h-lg-full w-lg-full mt-lg-0">
        <div class="mb-2">
          <h3 class="c-black">
            HTN controlled
          </h3>
        </div>
        <div class="table-responsive">
          <table id="htn-controlled-table" class="table-compact">
            <colgroup>
              <col>
              <col class="table-divider">
              <col class="table-divider">
            </colgrup>
            <thead>
              <tr class="sorts" data-sort-method="thead">
                <th class="row-label sort-label sort-label-small ta-left">
                  Name
                </th>
                <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" data-sort-default>
                  BP &lt;140/90
                </th>
                <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
                  Number of patients
                </th>
              </tr>
            </thead>
            <tbody>
              <% @region.facilities.order(:name).each do |facility| %>
                <tr>
                  <td class="ta-left">
                    <%= link_to(reports_region_path(facility.region_slug)) do %>
                      <%= facility.name %>
                    <% end %>
                  </td>
                  <td class="ta-left">
                    <%= number_to_percentage(@data_for_facility[facility.name]["controlled_patients_rate"].values.last, precision: 0) %>
                  </td>
                  <td class="ta-left">
                    <%= number_with_delimiter(@data_for_facility[facility.name]["controlled_patients"].values.last) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="d-lg-flex w-lg-50 pl-lg-2">
      <div class="card d-lg-flex fd-lg-column justify-lg-between h-lg-full w-lg-full mt-lg-0">
        <div class="mb-2">
          <h3 class="c-black">
            No BP measure
          </h3>
        </div>
        <div class="table-responsive">
          <table id="no-bp-measure-table" class="table-compact">
            <colgroup>
              <col>
              <col class="table-divider">
              <col class="table-divider">
              <col class="table-divider">
            </colgrup>
            <thead>
              <tr class="sorts" data-sort-method="thead">
                <th class="row-label sort-label sort-label-small ta-left">
                  Name
                </th>
                <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" data-sort-default>
                  Missed visit
                </th>
                <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
                  Lost to follow-up
                </th>
                <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
                  Visited but no BP
                </th>
              </tr>
            </thead>
            <tbody>
              <% @region.facilities.order(:name).each do |facility| %>
                <tr>
                  <td class="ta-left">
                    <%= link_to(reports_region_path(facility.region_slug)) do %>
                      <%= facility.name %>
                    <% end %>
                  </td>
                  <td class="ta-left">
                    N/A 
                  </td>
                  <td class="ta-left">
                    N/A
                  </td>
                  <td class="ta-left">
                    N/A
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="d-lg-flex w-lg-50 pr-lg-2">
      <div class="card d-lg-flex fd-lg-column justify-lg-between h-lg-full w-lg-full mt-lg-0">
        <div class="mb-2">
          <h3 class="c-black">
            HTN not under control
          </h3>
        </div>
        <div class="table-responsive">
          <table id="htn-not-under-control-table" class="table-compact">
            <colgroup>
              <col>
              <col class="table-divider">
              <col class="table-divider">
            </colgrup>
            <thead>
              <tr class="sorts" data-sort-method="thead">
                <th class="row-label sort-label sort-label-small ta-left">
                  Name
                </th>
                <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" data-sort-default>
                  BP &ge;140/90
                </th>
                <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
                  Number of patients
                </th>
              </tr>
            </thead>
            <tbody>
              <% @region.facilities.order(:name).each do |facility| %>
                <tr>
                  <td class="ta-left">
                    <%= link_to(reports_region_path(facility.region_slug)) do %>
                      <%= facility.name %>
                    <% end %>
                  </td>
                  <td class="ta-left">
                    <%= number_to_percentage(@data_for_facility[facility.name]["uncontrolled_patients_rate"].values.last, precision: 0) %>
                  </td>
                  <td class="ta-left">
                    <%= number_with_delimiter(@data_for_facility[facility.name]["uncontrolled_patients"].values.last) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="d-lg-flex w-lg-50 pl-lg-2">
      <div class="card d-lg-flex fd-lg-column justify-lg-between h-lg-full w-lg-full mt-lg-0">
        <div class="mb-2">
          <h3 class="c-black">
            Cumulative registrations
          </h3>
        </div>
        <div class="table-responsive">
          <table id="cumulative-registrations-table" class="table-compact">
            <colgroup>
              <col>
              <col class="table-divider">
              <col class="table-divider">
            </colgrup>
            <thead>
              <tr class="sorts" data-sort-method="thead">
                <th class="row-label sort-label sort-label-small ta-left">
                  Name
                </th>
                <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" data-sort-default>
                  Registrations in <%= @selected_date.to_s(:month_year) %>
                </th>
                <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
                  Cumulative
                </th>
              </tr>
            </thead>
            <tbody>
              <% @region.facilities.order(:name).each do |facility| %>
                <tr>
                  <td class="ta-left">
                    <%= link_to(reports_region_path(facility.region_slug)) do %>
                      <%= facility.name %>
                    <% end %>
                  </td>
                  <td class="ta-left">
                    <!-- <%= JSON.pretty_generate(@data_for_facility[facility.name]).gsub(":", " =>") %> -->
                    <% new_registrations = @data_for_facility[facility.name]["registrations"].values.last - @data_for_facility[facility.name]["registrations"].values[-2] %>
                    <%= number_with_delimiter(new_registrations) %>
                  </td>
                  <td class="ta-left">
                    <%= number_with_delimiter(@data_for_facility[facility.name]["cumulative_registrations"]) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<% end %>
<div id="data-json" style="display: none;">
  <%= raw @data.to_json %>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
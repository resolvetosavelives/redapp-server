<%= render "header"%>
<div class="card">
  <h3 class="mb-8px c-black">
    Visit details of all HTN patients
  </h3>
  <p class="mb-0px c-grey-dark">
    <%= number_with_delimiter(@data[:adjusted_registrations].values.last) %> assigned patients until the end of <%= @adjusted_registration_date %>
  </p>
  <% if @last_registration_value %>
    <div class="d-flex fd-column fd-lg-row">
      <div class="order-lg-2 w-lg-224px mt-lg-16px ml-lg-24px">
        <div class="d-flex align-baseline mb-8px mb-lg-16px">
          <div class="w-12px h-12px mr-12px br-2px bg-grey-medium"></div>
          <div class="d-flex flex-1 align-baseline fd-lg-column">
            <p class="w-48px m-0px fw-bold fs-20px lh-1 mb-lg-4px w-lg-full">
              <%= percentage_or_na(@data[:missed_visits_rate].values.last, precision: 0) %>
            </p>
            <p class="flex-1 m-0px fs-14px">
              No visit >3 months
            </p>
          </div>
        </div>
        <div class="d-flex align-baseline mb-8px mb-lg-16px">
          <div class="w-12px h-12px mr-12px br-2px bg-grey-dark"></div>
          <div class="d-flex flex-1 align-baseline fd-lg-column">
            <p class="w-48px m-0px fw-bold fs-20px lh-1 mb-lg-4px w-lg-full">
              <%= number_to_percentage(@data[:visited_without_bp_taken_rate].values.last, precision: 0) %>
            </p>
            <p class="flex-1 m-0px fs-14px">
              Visited but no BP recorded
              <span
                data-toggle="tooltip"
                data-placement="top"
                data-trigger="hover"
                title="Patients registered until the end of <%= @data[:adjusted_registrations].keys[-4] %> with an appointment scheduled, updated medicines, or blood sugar taken"
              >
                <i class="fas fa-info-circle ml-4px fs-12px c-grey-dark"></i>
              </span>
            </p>
          </div>
        </div>
        <div class="d-flex align-baseline mb-8px mb-lg-16px">
          <div class="w-12px h-12px mr-12px br-2px bg-red-medium"></div>
          <div class="d-flex flex-1 align-baseline fd-lg-column">
            <p class="w-48px m-0px fw-bold fs-20px lh-1 mb-lg-4px w-lg-full">
              <%= number_to_percentage(@data[:uncontrolled_patients_rate].values.last, precision: 0) %>
            </p>
            <p class="flex-1 m-0px fs-14px">
              BP not controlled
            </p>
          </div>
        </div>
        <div class="d-flex align-baseline mb-8px mb-lg-16px">
          <div class="w-12px h-12px mr-12px br-2px bg-green-dark"></div>
          <div class="d-flex flex-1 align-baseline fd-lg-column">
            <p class="w-48px m-0px fw-bold fs-20px lh-1 mb-lg-4px w-lg-full">
              <%= number_to_percentage(@data[:controlled_patients_rate].values.last, precision: 0) %>
            </p>
            <p class="flex-1 m-0px fs-14px">
              BP controlled
            </p>
          </div>
        </div>
        <div class="d-flex align-baseline mb-8px mb-lg-16px">
          <p class="mb-0px fs-12px c-grey-dark">
            <strong>Denominator:</strong> All hypertensive patients assigned to <%= @region.name %> registered before
            the last 3 months
          </p>
        </div>
      </div>
      <div class="flex-lg-1 order-lg-1">
        <canvas id="missedVisitDetails"></canvas>
      </div>
    </div>
  <% else %>
    <div class="d-flex align-center justify-center w-100pt h-200px h-lg-380px bl-1px bb-1px bl-grey-medium bb-grey-medium">
      <p class="c-grey-medium">
        No data available
      </p>
    </div>
  <% end %>
</div>
<% if @region.is_a?(Facility) %>
  <% if current_admin.permissions_v2_enabled? %>
    <% if current_admin.accessible_facilities(:view_reports).include?(@region) %>
      <%= render "shared/recent_bp_log",
                 blood_pressures: @recent_blood_pressures,
                 display_model: :facility %>
    <% end %>
  <% else %>
    <% if policy([:cohort_report, @region]).view_health_worker_activity? %>
      <%= render "shared/recent_bp_log",
                 blood_pressures: @recent_blood_pressures,
                 display_model: :facility %>
    <% end %>
  <% end %>
<% end %>

<% unless @region.is_a?(Facility) %>
  <% if current_admin.permissions_v2_enabled? %>
    <%= render "analytics/districts/follow_ups_table",
               dashboard_analytics: @dashboard_analytics,
               period: @period.type,
               row_resource: current_admin.accessible_facilities(:view_reports).order(:name),
               row_resource_display_field: :name,
               row_resource_link: :reports_region_facility_path %>
    <%= render "analytics/districts/registrations_table",
               dashboard_analytics: @dashboard_analytics,
               period: @period.type,
               row_resource: current_admin.accessible_facilities(:view_reports).order(:name),
               row_resource_display_field: :name,
               row_resource_link: :reports_region_facility_path %>
  <% else %>
    <%= render "analytics/districts/follow_ups_table",
               dashboard_analytics: @dashboard_analytics,
               period: @period.type,
               row_resource: Facility.order(:name),
               row_resource_display_field: :name,
               row_resource_link: :reports_region_facility_path %>
    <%= render "analytics/districts/registrations_table",
               dashboard_analytics: @dashboard_analytics,
               period: @period.type,
               row_resource: Facility.order(:name),
               row_resource_display_field: :name,
               row_resource_link: :reports_region_facility_path %>
  <% end %>
<% end %>


<div id="data-json" style="display: none;">
  <%= raw @data.to_json %>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

<% csv = CSV.generate(headers: true) do |csv|
  csv << ["Facility Report #{@period.to_date.strftime("%B %Y")}"]
  # need variable width header here
  month_labels = @months.map { |month| month.strftime("%b-%Y") }

  # HEADERS
  csv << [
    "Sr. No",
    "Name of the District",
    "Name of the Facility",
    "Type of Facility",
    "Name of the Block",
    "Active/Inactive (Inactive facilities have 0 BP measures taken)",
    "Est. HTN Population",
    "Total Reg",
    "Total Assigned Patients", # Total assigned patients are ALL patients assigned to a facility that aren't dead
    "Total LTFU", # only on original excel
    "Died", # only on original excel
    "Total Patients under Care", #Total patients under care are all patients assigned to a region that aren't dead, that have a BP taken within the last 12 months (the inverse of LTFU)
    month_labels,
    month_labels,
    "BP Controlled",
    "BP not Controlled",
    "Missed Visit",
    "Visited but BP not taken",
    "Amlodipine",
    "ARBs/ACE Inhibitors",
    "Diuretic"
  ].flatten

  # DISTRICT ROW
  registered_by_month = @months.map do |month|
    @dashboard_analytics.sum { |_, data| data.dig(:registered_patients_by_period, month) || 0 }
  end
  follow_up_by_month = @months.map do |month|
    @dashboard_analytics.sum { |_, data| data.dig(:follow_up_patients_by_period, month) || 0 }
  end
  csv << [
    "All",
    @region.name,
    nil,
    nil,
    nil,
    nil,
    nil,
    @dashboard_analytics.sum { |_, facility| facility.dig(:total_registered_patients) },
    @dashboard_analytics.sum { |_, facility| facility.dig(:total_assigned_patients) },
    "Total under care rollup", # sum parts
    nil,
    nil,
    *registered_by_month,
    *follow_up_by_month,
    "BP controlled", # sum
    "BP not controlled", # sum
    "Missed Visit", # is this defaulted?
    "Visited but BP not taken", # not sure where to get this
    nil,
    nil,
    nil
  ]

  # FACILITY ROWS
  @region.facilities.each_with_index do |facility, index|
    analytics_data = @dashboard_analytics[facility.id]
    dead = facility.registered_patients.where(status: "dead").count
    registration_numbers = []
    follow_up_numbers = []

    @months.each do |month|
      registration_numbers << (@dashboard_analytics.dig(facility.id, :registered_patients_by_period, month) || 0)
      follow_up_numbers << (@dashboard_analytics.dig(facility.id, :follow_up_patients_by_period, month) || 0)
    end

    csv << [
      index + 1,
      @region.name,
      facility.name,
      facility.facility_type,
      facility.block,
      facility.blood_pressures.any?,
      nil,
      @dashboard_analytics.dig(facility.id, :total_registered_patients),
      @dashboard_analytics.dig(facility.id, :total_assigned_patients),
      "ltfu",
      dead,
      @dashboard_analytics.dig(facility.id, :total_assigned_patients),
      *registration_numbers,
      *follow_up_numbers,
      "BP controlled",
      "BP not Controlled",
      "Missed Visit",
      "Visited but BP not taken",
      nil,
      nil,
      nil
    ]
  end
end.html_safe %>
<%= csv %>

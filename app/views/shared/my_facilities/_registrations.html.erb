<div class="card card-responsive">
  <div class="row">
    <div class="col-lg-9 pr-5 pr-md-0">
      <h3>New patient registrations</h3>
      <p>OPD % indicates the percentage of estimated OPD patients that are registered. Estimated monthly OPD load is updated annually by surveillance officers.</p>
    </div>

    <div class="mt-1 mb-3 col-lg-3">
      <div class="dropdown show">
        <a class="btn btn-sm btn-outline btn-secondary dropdown-toggle" href="#"
           role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="min-width: 12em;">
          <%= @periods[@selected_period] %>
        </a>

        <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
          <% @periods.each do |period, period_name| %>
            <button type="submit" name="period" value=<%= period %> class="dropdown-item" form="query-filters"><%= period_name %></button>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <table class="mt-3 mt-lg-4 table table-compact table-responsive-md table-hover" id="analytics-table">
    <colgroup>
      <col>
      <col class="table-divider">
      <col>
      <col class="table-divider">
      <col>
      <col class="table-divider">
      <col>
      <col class="table-divider">
      <col class="mobile">
    </colgroup>
    <thead>
    <tr>
      <th></th>
      <% case @selected_period %>
      <% when :quarter %>
        <% @display_periods.reverse.each do |(year, quarter)| %>
          <th colspan="2"><%= "Q#{quarter}-#{year}" %></th>
        <% end %>
      <% when :month %>
        <% @display_periods.reverse.each do |(year, month)| %>
          <th colspan="2"><%= month_short_name_and_year(month_start(year, month)) %></th>
        <% end %>
      <% when :day %>
        <% @display_periods.reverse.each do |(year, doy)| %>
          <th colspan="2"><%= doy_to_date(year, doy) %></th>
        <% end %>
      <% end %>
      <th>ALL-TIME</th>
    </tr>
    <tr data-sort-method="thead" class="sorts">
      <th class="row-label sort-label">Facilities</th>
      <% @display_periods.each do |_|%>
        <th class="row-label sort-label" data-sort-default data-sort-method="number">% of OPD</th>
        <th class="row-label sort-label">Registered</th>
      <% end %>
      <th class="row-label sort-label">Registered patients <sup>1</sup></th>
      <th class="mobile">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
    </tr>
    </thead>
    <tbody>
    <tr class="row-total" data-sort-method="none">
      <td class="type-title">All</td>
      <td class="type-percent"><em>100%</em></td>
      <td class="type-number">12,345</td>
      <td class="type-percent"><em>100%</em></td>
      <td class="type-number">12,345</td>
      <td class="type-percent"><em>100%</em></td>
      <td class="type-number">12,345</td>
      <td class="type-number"></td>
    </tr>
    <% @facilities.each do |facility| %>
      <tr data-sort-method="none">
        <td class="type-title"><%= facility.name %></td>
        <% @display_periods.reverse.each do |period| %>
          <td class="type-percent">
            <em><%= percentage(@registrations[[facility.id, period.first.to_s, period.second.to_s]], facility.monthly_opd_load) %></em>
          </td>
          <td class="type-number"><%= @registrations[[facility.id, period.first.to_s, period.second.to_s]].to_i %></td>
        <% end %>
        <td class="type-number">43,346</td>
      </tr>
    <% end %>
    </tbody>
  </table>
</div>
<section class="footnotes">
  <ol>
    <li><strong>All registered patients:</strong> All registered patients with exclusions for: lost to follow-up, transferred to another public facility, and died.</li>
  </ol>
</section>
